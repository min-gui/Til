name: Wiki Update with Enhanced Preview
on:
  gollum:
jobs:
  notify:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Send Wiki Update to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
          TITLE="${{ github.event.pages[0].title }}"
          ACTION="${{ github.event.pages[0].action }}"
          URL="${{ github.event.pages[0].html_url }}"
          EDITOR="${{ github.event.sender.login }}"
          PAGE_NAME="${{ github.event.pages[0].page_name }}"
          
          # ì•¡ì…˜ í•œê¸€ ë³€í™˜
          case "$ACTION" in
            "created") ACTION_KR="ìƒì„±" EMOJI="âœ¨" ;;
            "edited") ACTION_KR="ìˆ˜ì •" EMOJI="ğŸ“" ;;
            "deleted") ACTION_KR="ì‚­ì œ" EMOJI="ğŸ—‘ï¸" ;;
            *) ACTION_KR="$ACTION" EMOJI="ğŸ“„" ;;
          esac
          
          # Wiki ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ê°œì„ ëœ ë²„ì „)
          PREVIEW=""
          if [ "$ACTION" != "deleted" ]; then
            git clone -q --depth 1 https://github.com/${{ github.repository }}.wiki.git w 2>/dev/null && {
              for ext in .md .markdown ""; do
                [ -f "w/${PAGE_NAME}${ext}" ] && {
                  # ì²« ë²ˆì§¸ ì¤„ë¶€í„° 5ì¤„ê¹Œì§€ ì¶”ì¶œí•˜ë˜, ì˜ë¯¸ ìˆëŠ” ë‚´ìš©ë§Œ í•„í„°ë§
                  PREVIEW=$(cat "w/${PAGE_NAME}${ext}" | \
                    sed '/^$/d' | \
                    sed '/^[[:space:]]*$/d' | \
                    sed 's/^[[:space:]]*//' | \
                    head -5 | \
                    sed 's/^#*[[:space:]]*//' | \
                    sed 's/^\*[[:space:]]*/â€¢ /' | \
                    sed 's/^-[[:space:]]*/â€¢ /')
                  break
                }
              done
              rm -rf w
            }
          fi
          
          [ -z "$PREVIEW" ] && PREVIEW="ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ"
          
          # ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¸”ë¡ìœ¼ë¡œ êµ¬ì„± (ìµœëŒ€ 5ì¤„)
          PREVIEW_LINES=""
          LINE_COUNT=0
          while IFS= read -r line && [ $LINE_COUNT -lt 5 ]; do
            [ -n "$line" ] && {
              PREVIEW_LINES="$PREVIEW_LINES$line\n"
              LINE_COUNT=$((LINE_COUNT + 1))
            }
          done << EOF
          $PREVIEW
          EOF
          
          # ë¯¸ë¦¬ë³´ê¸°ê°€ ìˆìœ¼ë©´ ë¸”ë¡ êµ¬ì„±, ì—†ìœ¼ë©´ ê°„ë‹¨í•œ contextë§Œ
          if [ -n "$PREVIEW_LINES" ] && [ "$PREVIEW_LINES" != "ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ" ]; then
            PREVIEW_BLOCK='[
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "'"$EMOJI"' *'"$TITLE"'* í˜ì´ì§€ê°€ '"$ACTION_KR"'ë˜ì—ˆìŠµë‹ˆë‹¤\nğŸ‘¤ '"$EDITOR"' â€¢ ğŸ“… '"$(TZ='Asia/Seoul' date '+%m/%d %H:%M')"'"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "```\n'"$(echo "$PREVIEW_LINES" | sed 's/"/\\"/g')"'\n```"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<'"$URL"'|ğŸ“– ì „ì²´ ë‚´ìš© ë³´ëŸ¬ê°€ê¸°>"
                }
              }
            ]'
          else
            PREVIEW_BLOCK='[
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "'"$EMOJI"' *'"$TITLE"'* í˜ì´ì§€ê°€ '"$ACTION_KR"'ë˜ì—ˆìŠµë‹ˆë‹¤\nğŸ‘¤ '"$EDITOR"' â€¢ ğŸ“… '"$(TZ='Asia/Seoul' date '+%m/%d %H:%M')"'"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<'"$URL"'|ğŸ“– ì „ì²´ ë‚´ìš© ë³´ëŸ¬ê°€ê¸°>"
                }
              }
            ]'
          fi
          
          # Slack ë©”ì‹œì§€ ì „ì†¡
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d '{
              "text": "'"$EMOJI"' Wiki '"$ACTION_KR"': '"$TITLE"'",
              "blocks": '"$PREVIEW_BLOCK"'
            }'
