name: Wiki Update with Clean Preview

on:
  gollum:

jobs:
  notify:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Send Wiki Update to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
          TITLE="${{ github.event.pages[0].title }}"
          ACTION="${{ github.event.pages[0].action }}"
          URL="${{ github.event.pages[0].html_url }}"
          EDITOR="${{ github.event.sender.login }}"
          PAGE_NAME="${{ github.event.pages[0].page_name }}"
          
          # ì•¡ì…˜ í•œê¸€ ë³€í™˜
          case "$ACTION" in
            "created") ACTION_KR="ìƒì„±" EMOJI="âœ¨" ;;
            "edited") ACTION_KR="ìˆ˜ì •" EMOJI="ğŸ“" ;;
            "deleted") ACTION_KR="ì‚­ì œ" EMOJI="ğŸ—‘ï¸" ;;
            *) ACTION_KR="$ACTION" EMOJI="ğŸ“„" ;;
          esac
          
          # Wiki ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°
          PREVIEW=""
          if [ "$ACTION" != "deleted" ]; then
            git clone -q --depth 1 https://github.com/${{ github.repository }}.wiki.git w 2>/dev/null && {
              for ext in .md .markdown ""; do
                [ -f "w/${PAGE_NAME}${ext}" ] && {
                  PREVIEW=$(cat "w/${PAGE_NAME}${ext}" | grep -v '^#' | grep -v '^$' | head -5 | sed 's/^[[:space:]]*//')
                  break
                }
              done
              rm -rf w
            }
          fi
          
          [ -z "$PREVIEW" ] && PREVIEW="ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ"
          
          # ì¤„ë°”ê¿ˆì„ ìŠ¤í˜ì´ìŠ¤ë¡œ ë³€í™˜ (í•œ ì¤„ë¡œ í‘œì‹œ)
          PREVIEW_ONELINE=$(echo "$PREVIEW" | tr '\n' ' ' | cut -c1-200)
          
          # Slack ë©”ì‹œì§€ ì „ì†¡
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d '{
              "text": "'"$EMOJI"' Wiki '"$ACTION_KR"': '"$TITLE"'",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "'"$EMOJI"' *'"$TITLE"'* í˜ì´ì§€ê°€ '"$ACTION_KR"'ë˜ì—ˆìŠµë‹ˆë‹¤\nğŸ‘¤ '"$EDITOR"' â€¢ ğŸ“… '"$(TZ='Asia/Seoul' date '+%m/%d %H:%M')"'"
                  }
                },
                {
                  "type": "context",
                  "elements": [{
                    "type": "mrkdwn",
                    "text": "_'"${PREVIEW_ONELINE}"'..._"
                  }]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<'"$URL"'|ğŸ“– ì „ì²´ ë‚´ìš© ë³´ëŸ¬ê°€ê¸°>"
                  }
                }
              ]
            }'
