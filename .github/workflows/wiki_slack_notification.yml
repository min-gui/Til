name: Wiki Update with Clean Preview

on:
  gollum:

jobs:
  notify:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Send Wiki Update to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # 기본 정보 추출
          TITLE="${{ github.event.pages[0].title }}"
          ACTION="${{ github.event.pages[0].action }}"
          URL="${{ github.event.pages[0].html_url }}"
          EDITOR="${{ github.event.sender.login }}"
          PAGE_NAME="${{ github.event.pages[0].page_name }}"
          
          # 액션 한글 변환
          case "$ACTION" in
            "created") ACTION_KR="생성" EMOJI="✨" ;;
            "edited") ACTION_KR="수정" EMOJI="📝" ;;
            "deleted") ACTION_KR="삭제" EMOJI="🗑️" ;;
            *) ACTION_KR="$ACTION" EMOJI="📄" ;;
          esac
          
          # Wiki 내용 미리보기
          PREVIEW=""
          if [ "$ACTION" != "deleted" ]; then
            git clone -q --depth 1 https://github.com/${{ github.repository }}.wiki.git w 2>/dev/null && {
              for ext in .md .markdown ""; do
                [ -f "w/${PAGE_NAME}${ext}" ] && {
                  PREVIEW=$(cat "w/${PAGE_NAME}${ext}" | grep -v '^#' | grep -v '^$' | head -5 | sed 's/^[[:space:]]*//')
                  break
                }
              done
              rm -rf w
            }
          fi
          
          [ -z "$PREVIEW" ] && PREVIEW="미리보기 없음"
          
          # 줄바꿈을 스페이스로 변환 (한 줄로 표시)
          PREVIEW_ONELINE=$(echo "$PREVIEW" | tr '\n' ' ' | cut -c1-200)
          
          # Slack 메시지 전송
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d '{
              "text": "'"$EMOJI"' Wiki '"$ACTION_KR"': '"$TITLE"'",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "'"$EMOJI"' *'"$TITLE"'* 페이지가 '"$ACTION_KR"'되었습니다\n👤 '"$EDITOR"' • 📅 '"$(TZ='Asia/Seoul' date '+%m/%d %H:%M')"'"
                  }
                },
                {
                  "type": "context",
                  "elements": [{
                    "type": "mrkdwn",
                    "text": "_'"${PREVIEW_ONELINE}"'..._"
                  }]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<'"$URL"'|📖 전체 내용 보러가기>"
                  }
                }
              ]
            }'
